$schema: https://azuremlschemas.azureedge.net/latest/commandJob.schema.json

experiment_name: pytorch_mnist

code: ./src

# command: |
#   sleep 10
#   ray status
#   python train.py
#   ray status
command: >-
  ray stop
  if [ $AZUREML_CR_NODE_RANK == 0 ]
  then
    ray start --head
    ray status
    sleep 10
    ray status
    python train.py
    ray status
  else
    ray start --address=$AZ_BATCHAI_JOB_MASTER_NODE_IP:6379
  fi

environment: azureml:ray-torch@latest
compute: azureml:compute-gpu

resources:
  instance_count: 3

environment_variables:
  AZUREML_COMPUTE_USE_COMMON_RUNTIME: "true"
  AZUREML_COMMON_RUNTIME_USE_INTERACTIVE_CAPABILITY: "True"

# distribution:
#     type: ray

services:
  ray_dahboard:
    port: 8265
  my_ssh:
    job_service_type: SSH
    properties:
      sshPublicKeys: <ssh-public-keys>
